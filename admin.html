<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard — CodePulse</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Small admin-specific overrides */
      .admin-container {
        padding: 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .admin-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 18px;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .card {
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .table-wrap {
        overflow: auto;
        border-radius: 8px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }
      th {
        background: rgba(0, 0, 0, 0.03);
        font-weight: 700;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 8px;
        border: 0;
        cursor: pointer;
      }
      .btn-primary {
        background: var(--accent-color);
        color: #fff;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      .search-input {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        min-width: 200px;
      }
      .small {
        font-size: 13px;
        color: var(--text-color);
      }
      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 9999;
        padding: 16px;
      }
      .modal-card {
        width: 100%;
        max-width: 900px;
        background: var(--bg-color);
        padding: 12px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
      }
      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-color);
        display: block;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .form-grid .full {
        grid-column: 1/-1;
      }
      .input {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }
      @media (max-width: 720px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }
      .badge {
        display: inline-block;
        padding: 6px 8px;
        border-radius: 999px;
        font-weight: 700;
      }
      .badge-present {
        background: #dff0d8;
        color: #3c763d;
      }
      .badge-absent {
        background: #f2dede;
        color: #a94442;
      }
      .muted {
        color: #666;
        font-size: 13px;
      }

      .seat-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      .seat-tile {
        width: 96px;
        min-height: 64px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
      }
      .seat-tile.occupied {
        background: linear-gradient(90deg, #fff7e6, #eafaf1);
        border-color: #ffd966;
      }
      .seat-tile.empty {
        background: #ffffff;
      }
      .seat-roll {
        font-weight: 700;
        font-size: 0.9rem;
        color: #333;
      }
      .seat-name {
        font-size: 0.85rem;
        color: #666;
        margin-top: 6px;
        text-align: center;
        max-width: 90px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="">
    <!-- keep dark or remove to match your theme -->
    <div class="admin-container">
      <div class="admin-header">
        <div>
          <h1>Admin Dashboard</h1>
          <!-- ================= Year & Section + Seat Grid ================= -->
          <div
            class="admin-seat-controls"
            style="
              margin: 1rem 0;
              padding: 1rem;
              border: 1px solid #ddd;
              border-radius: 8px;
              background: #fafafa;
            "
          >
            <div
              style="
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <label style="font-weight: 600">Select Year</label>
              <select id="yearSelect" aria-label="Select Year"></select>

              <label style="font-weight: 600">Select Section</label>
              <select id="sectionSelect" aria-label="Select Section"></select>

              <button
                id="generateSeatsBtn"
                style="
                  padding: 0.5rem 1rem;
                  border-radius: 6px;
                  background: linear-gradient(90deg, #007bff, #28a745);
                  color: #fff;
                  border: none;
                  cursor: pointer;
                "
              >
                Show Seats
              </button>
            </div>

            <div id="seatGridContainer" style="margin-top: 1rem"></div>
          </div>
          <!-- ================= End Year & Section + Seat Grid ================= -->

          <div class="muted">
            Manage student details, attendance, marks and exports
          </div>
        </div>

        <div class="controls">
          <input
            id="searchInput"
            class="search-input"
            placeholder="Search by name / roll / branch"
          />
          <button id="addStudentBtn" class="btn btn-primary">
            + Add Student
          </button>
          <button id="exportBtn" class="btn btn-ghost">Export JSON</button>
          <label class="btn btn-ghost" style="cursor: pointer">
            Import JSON
            <input
              id="importFile"
              type="file"
              accept="application/json"
              style="display: none"
            />
          </label>
          <button id="logoutBtn" class="btn">Logout</button>
        </div>
      </div>

      <!-- Attendance Management Section -->
      <div class="card">
        <h3>Mark Attendance</h3>
        <div
          style="
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
          "
        >
          <label for="attendanceDate">Date:</label>
          <input type="date" id="attendanceDate" value="" />
          <label for="attendanceSubject">Subject:</label>
          <select
            id="attendanceSubject"
            class="input"
            style="width: auto; padding: 8px"
          >
            <option value="Math">Math</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Computer Science">Computer Science</option>
            <option value="English">English</option>
          </select>
          <button id="markAttendanceBtn" class="btn btn-primary">
            Mark Attendance
          </button>
        </div>
        <div id="attendanceList" style="max-height: 400px; overflow-y: auto">
          <!-- Student list for attendance will be rendered here -->
        </div>
      </div>

      <!-- Quiz Marks Management Section -->
      <div class="card">
        <h3>Edit Quiz Marks</h3>
        <div
          style="
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
          "
        >
          <label for="quizSubject">Subject:</label>
          <select
            id="quizSubject"
            class="input"
            style="width: auto; padding: 8px"
          >
            <option value="Mathematics">Mathematics</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Data Structures">Data Structures</option>
            <option value="Algorithms">Algorithms</option>
            <option value="Operating Systems">Operating Systems</option>
          </select>
          <button id="loadQuizMarksBtn" class="btn btn-primary">
            Load Quiz Marks
          </button>
          <button id="saveQuizMarksBtn" class="btn btn-primary">
            Save Quiz Marks
          </button>
        </div>
        <div id="quizMarksList" style="max-height: 400px; overflow-y: auto">
          <!-- Quiz marks table will be rendered here -->
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table id="studentsTable" aria-live="polite">
            <thead>
              <tr>
                <th>Roll</th>
                <th>Name</th>
                <th>Branch</th>
                <th>Semester</th>
                <th>Streak</th>
                <th>Attendance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTbody">
              <!-- rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- View / Edit Modal -->
    <div id="modal" class="modal" style="display: none">
      <div class="modal-card" role="dialog" aria-modal="true">
        <h2 id="modalTitle">Student</h2>
        <form id="studentForm">
          <div class="form-grid" id="formGrid">
            <div>
              <label class="small">Roll Number</label>
              <input id="fRoll" class="input" required />
            </div>
            <div>
              <label class="small">Name</label>
              <input id="fName" class="input" required />
            </div>

            <div>
              <label class="small">College</label>
              <input id="fCollege" class="input" />
            </div>
            <div>
              <label class="small">Branch</label>
              <input id="fBranch" class="input" />
            </div>

            <div>
              <label class="small">Semester</label>
              <input id="fSemester" class="input" />
            </div>
            <div>
              <label class="small">Streak (days)</label>
              <input id="fStreak" class="input" type="number" min="0" />
            </div>

            <div>
              <label class="small" for="fEmail">Email</label>
              <input id="fEmail" class="input" type="email" placeholder="e.g. student@gmail.com">
            </div>

            <div>

              <input id="fPassword" class="input" type="password" />
            </div>

            <div>
              <label class="small" for="fGithub">GitHub Username</label>
              <input id="fGithub" class="input" />
            </div>

            <div>
              <label class="small" for="fLinkedin">LinkedIn URL</label>
              <input id="fLinkedin" class="input" />
            </div>

            <div>
              <label class="small" for="fCodeforces">Codeforces URL</label>
              <input id="fCodeforces" class="input" />
            </div>

            <div>
              <label class="small">CodeChef URL</label>
              <input id="fCodechef" class="input" />
            </div>

            <div class="full">
              <label class="small" for="fAttendance">
                Attendance (comma-separated dates or "present/absent" items)
              </label>
              <input
                id="fAttendance"
                class="input"
                placeholder="e.g. 2025-11-01:present,2025-11-02:absent"
              />
              <small class="muted">You can store attendance as simple CSV pairs for demo.</small>
            </div>

            <div class="full">
              <label class="small" for="fMarks">
                Marks (JSON array) — e.g. [{"subject":"Math","marks":85}]
              </label>
              <input
                id="fMarks"
                class="input"
                placeholder='[{"subject":"Math","marks":85}]'
              />
              <small class="muted">Store quiz/test marks as JSON (for demo frontend).</small>
            </div>
          </div>

          <div class="actions">
            <button type="button" id="deleteBtn" class="btn btn-danger">Delete</button>
            <button type="button" id="cancelBtn" class="btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      /* Admin Dashboard JS (front-end only)
   - Uses localStorage key "codepulse_students" to persist student list
   - Each student is an object:
     { roll, name, college, branch, semester, streak, email, location, github, linkedin, codeforces, attendance: "csv", marks: 'json-string' }
*/

      // --- Utilities ---
      const STORAGE_KEY = "codepulse_students";
      const ADMIN_FLAG = "codepulse_admin"; // demo flag stored in sessionStorage by login page (optional)

      // Protect page: if sessionStorage not show admin flag, prompt to login
      (function protect() {
        const admin = sessionStorage.getItem(ADMIN_FLAG);
        // if your login page didn't set this, you can comment out next lines.
        if (admin !== "true") {
          // Optional: allow access when not set (for dev). We'll still show a confirm.
          const ok = confirm(
            "Admin not signed-in via demo flow. Continue to admin dashboard? (In production, require sign-in)"
          );
          if (!ok) {
            window.location.href = "login.html";
          }
        }
      })();

      // --- Data CRUD ---
      function readStudents() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        try {
          return JSON.parse(raw);
        } catch (e) {
          return [];
        }
      }
      function writeStudents(arr) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      }

      // seed with sample if empty for convenience
      (function seed() {
        const s = readStudents();
        if (s.length === 0) {
          const demo = [
            {
              roll: "298-2030",
              name: "Shivam Maurya",
              college: "ABC College",
              branch: "CSE",
              semester: "1",
              streak: 5,
              email: "shivam@example.com",
              location: "Lucknow",
              github: "shivam",
              linkedin: "",
              codeforces: "",
              attendance: "2025-11-01:present,2025-11-02:absent",
              marks: "[]",
            },
            {
              roll: "298-2031",
              name: "Rohit Kumar",
              college: "ABC College",
              branch: "CSE",
              semester: "1",
              streak: 2,
              email: "rohit@example.com",
              location: "Lucknow",
              github: "rohit",
              linkedin: "",
              codeforces: "",
              attendance: "2025-11-01:present",
              marks: "[]",
            },
          ];
          writeStudents(demo);
        }
      })();

      // --- DOM elements ---
      const tbody = document.getElementById("studentsTbody");
      const searchInput = document.getElementById("searchInput");
      const addBtn = document.getElementById("addStudentBtn");
      const exportBtn = document.getElementById("exportBtn");
      const importFile = document.getElementById("importFile");
      const logoutBtn = document.getElementById("logoutBtn");

      // modal
      const modal = document.getElementById("modal");
      const studentForm = document.getElementById("studentForm");
      const modalTitle = document.getElementById("modalTitle");
      const deleteBtn = document.getElementById("deleteBtn");
      const cancelBtn = document.getElementById("cancelBtn");

      // form fields
      const fRoll = document.getElementById("fRoll");
      const fName = document.getElementById("fName");
      const fCollege = document.getElementById("fCollege");
      const fBranch = document.getElementById("fBranch");
      const fSemester = document.getElementById("fSemester");
      const fStreak = document.getElementById("fStreak");
      const fEmail = document.getElementById("fEmail");
      const fLocation = document.getElementById("fLocation");
      const fGithub = document.getElementById("fGithub");
      const fLinkedin = document.getElementById("fLinkedin");
      const fCodeforces = document.getElementById("fCodeforces");
      const fCodechef = document.getElementById("fCodechef");
      const fAttendance = document.getElementById("fAttendance");
      const fMarks = document.getElementById("fMarks");

      let editingRoll = null; // which roll is being edited

      // --- Render table ---
      function renderTable(filter = "") {
        const list = readStudents();
        const q = filter.trim().toLowerCase();
        tbody.innerHTML = "";

        const filtered = list.filter((s) => {
          if (!q) return true;
          return (
            (s.roll || "").toLowerCase().includes(q) ||
            (s.name || "").toLowerCase().includes(q) ||
            (s.branch || "").toLowerCase().includes(q)
          );
        });

        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="small muted">No students found.</td></tr>`;
          return;
        }

        for (const s of filtered) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${escapeHtml(s.roll || "")}</td>
      <td>${escapeHtml(s.name || "")}</td>
      <td>${escapeHtml(s.branch || "")}</td>
      <td>${escapeHtml(s.semester || "")}</td>
      <td>${escapeHtml(String(s.streak || 0))}</td>
      <td>${attendanceBadge(s.attendance)}</td>
      <td>
        <button class="btn" onclick="viewStudent('${encodeKey(
          s.roll
        )}')">View</button>
        <button class="btn btn-primary" onclick="editStudent('${encodeKey(
          s.roll
        )}')">Edit</button>
        <button class="btn btn-danger" onclick="removeStudentConfirm('${encodeKey(
          s.roll
        )}')">Delete</button>
      </td>
    `;
          tbody.appendChild(tr);
        }
      }

      function attendanceBadge(att) {
        if (!att) return '<span class="muted">—</span>';
        // simple parse: if last entry present -> present badge
        try {
          const parts = att.split(",");
          const last = parts[parts.length - 1];
          if (last.includes(":")) {
            const segments = last.split(":");
            if (segments.length >= 3) {
              const status = segments[2].trim();
              if (/present/i.test(status))
                return `<span class="badge badge-present">Present</span>`;
              if (/absent/i.test(status))
                return `<span class="badge badge-absent">Absent</span>`;
            }
          }
        } catch (e) {}
        return `<span class="muted">Recorded</span>`;
      }

      // --- Helpers ---
      function escapeHtml(s) {
        if (!s) return "";
        return String(s).replace(
          /[&<>"]/g,
          (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c])
        );
      }
      function encodeKey(s) {
        return encodeURIComponent(String(s || ""));
      }
      function decodeKey(s) {
        return decodeURIComponent(s || "");
      }

      // --- CRUD actions ---
      function viewStudent(key) {
        const roll = decodeKey(key);
        const student = readStudents().find((x) => x.roll === roll);
        if (!student) return alert("Student not found");
        // populate a readonly view by filling fields but disabling them
        modalTitle.textContent = `View — ${student.name} (${student.roll})`;
        fillForm(student);
        setFormReadonly(true);
        deleteBtn.style.display = "none";
        modal.style.display = "flex";
      }

      function editStudent(key) {
        const roll = decodeKey(key);
        const student = readStudents().find((x) => x.roll === roll);
        if (!student) return alert("Student not found");
        modalTitle.textContent = `Edit — ${student.name} (${student.roll})`;
        fillForm(student);
        setFormReadonly(false);
        editingRoll = student.roll;
        deleteBtn.style.display = "inline-block";
        modal.style.display = "flex";
      }

      function addStudent() {
        modalTitle.textContent = "Add New Student";
        studentForm.reset();
        setFormReadonly(false);
        editingRoll = null;
        deleteBtn.style.display = "none";
        modal.style.display = "flex";
      }

      function fillForm(s) {
        fRoll.value = s.roll || "";
        fName.value = s.name || "";
        fCollege.value = s.college || "";
        fBranch.value = s.branch || "";
        fSemester.value = s.semester || "";
        fStreak.value = s.streak || 0;
        fEmail.value = s.email || "";
        fLocation.value = s.location || "";
        fGithub.value = s.github || "";
        fLinkedin.value = s.linkedin || "";
        fCodeforces.value = s.codeforces || "";
        fCodechef.value = s.codechef || "";
        fAttendance.value = s.attendance || "";
        fMarks.value = s.marks || "[]";
      }

      function setFormReadonly(flag) {
        const inputs = studentForm.querySelectorAll("input");
        inputs.forEach((i) => (i.disabled = flag));
        studentForm.querySelector('button[type="submit"]').style.display = flag
          ? "none"
          : "inline-block";
      }

      function removeStudentConfirm(key) {
        const roll = decodeKey(key);
        if (!confirm(`Delete student ${roll}? This cannot be undone.`)) return;
        removeStudent(roll);
      }

      function removeStudent(roll) {
        const arr = readStudents().filter((x) => x.roll !== roll);
        writeStudents(arr);
        renderTable(searchInput.value);
        closeModal();
      }

      // --- Form submit save ---
      // studentForm.addEventListener('submit', function(e){
      //   e.preventDefault();
      //   const newObj = {
      //     roll: fRoll.value.trim(),
      //     name: fName.value.trim(),
      //     college: fCollege.value.trim(),
      //     branch: fBranch.value.trim(),
      //     semester: fSemester.value.trim(),
      //     streak: Number(fStreak.value) || 0,
      //     email: fEmail.value.trim(),
      //     location: fLocation.value.trim(),
      //     github: fGithub.value.trim(),
      //     linkedin: fLinkedin.value.trim(),
      //     codeforces: fCodeforces.value.trim(),
      //     attendance: fAttendance.value.trim(),
      //     marks: fMarks.value.trim() || '[]'
      //   };

      //   if (!newObj.roll || !newObj.name) {
      //     alert('Roll and Name are required');
      //     return;
      //   }

      //   const arr = readStudents();

      //   if (editingRoll) {
      //     // update existing
      //     const idx = arr.findIndex(x => x.roll === editingRoll);
      //     if (idx === -1) return alert('Original student not found');
      //     // prevent duplicate roll updates
      //     if (newObj.roll !== editingRoll && arr.some(x => x.roll === newObj.roll)) {
      //       return alert('Another student already uses this roll number');
      //     }
      //     arr[idx] = newObj;
      //     writeStudents(arr);
      //     renderTable(searchInput.value);
      //     closeModal();
      //     return;
      //   }

      //   // adding new: check duplicate roll
      //   if (arr.some(x => x.roll === newObj.roll)) {
      //     if (!confirm('A student with this roll already exists. Overwrite?')) return;
      //     // overwrite
      //     const idx = arr.findIndex(x => x.roll === newObj.roll);
      //     arr[idx] = newObj;
      //   } else {
      //     arr.push(newObj);
      //   }
      //   writeStudents(arr);
      //   renderTable(searchInput.value);
      //   closeModal();
      // });

      studentForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const roll = fRoll.value.trim();
        const name = fName.value.trim();
        const college = fCollege.value.trim();
        const branch = fBranch.value.trim();
        const semester = fSemester.value.trim();
        const streak = Number(fStreak.value) || 0;
        const email = fEmail.value.trim();
        const location = fLocation.value.trim();
        const github = fGithub.value.trim();
        const linkedin = fLinkedin.value.trim();
        const codeforces = fCodeforces.value.trim();
        const codechef = fCodechef.value.trim();
        const attendance = fAttendance.value.trim();
        const marks = fMarks.value.trim();
        const password = document.getElementById("fPassword").value; // new line

        if (!roll || !name) {
          alert("Roll and Name are required.");
          return;
        }

        const students = readStudents();

        if (editingRoll) {
          const idx = students.findIndex((s) => s.roll === editingRoll);
          if (idx !== -1) {
            students[idx] = {
              ...students[idx],
              roll,
              name,
              college,
              branch,
              semester,
              streak,
              email,
              location,
              github,
              linkedin,
              codeforces,
              attendance,
              marks,
              password,
            };
          }
        } else {
          if (students.some((s) => s.roll === roll)) {
            alert("Student already exists.");
            return;
          }
          students.push({
            roll,
            name,
            college,
            branch,
            semester,
            streak,
            email,
            location,
            github,
            linkedin,
            codeforces,
            attendance,
            marks,
            password,
          });
        }

        writeStudents(students);
        renderTable(searchInput.value || "");
        closeModal();
      });

      // delete button in modal
      deleteBtn.addEventListener("click", function () {
        if (!editingRoll) return;
        if (!confirm("Delete this student?")) return;
        removeStudent(editingRoll);
      });

      // cancel
      cancelBtn.addEventListener("click", closeModal);

      // close button

      // close modal utility
      function closeModal() {
        modal.style.display = "none";
        setTimeout(() => {
          // clear fields
          studentForm.reset();
          editingRoll = null;
        }, 200);
      }

      // --- Import / Export ---
      exportBtn.addEventListener("click", function () {
        const arr = readStudents();
        const blob = new Blob([JSON.stringify(arr, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "codepulse_students.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importFile.addEventListener("change", function (ev) {
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported))
              throw new Error("Invalid JSON format (expected array)");
            // merge imported (avoid duplicates by roll)
            const cur = readStudents();
            const merged = [...cur];
            for (const s of imported) {
              if (!s.roll) continue;
              const idx = merged.findIndex((x) => x.roll === s.roll);
              if (idx === -1) merged.push(s);
              else merged[idx] = s; // overwrite
            }
            writeStudents(merged);
            renderTable();
            alert("Import successful");
          } catch (ex) {
            alert("Import failed: " + ex.message);
          }
        };
        reader.readAsText(file);
        // reset input
        ev.target.value = "";
      });

      // --- Search & events ---
      searchInput.addEventListener("input", () =>
        renderTable(searchInput.value)
      );
      addBtn.addEventListener("click", addStudent);

      // quick view / edit functions must be available globally for inline onclick in table rows
      window.viewStudent = viewStudent;
      window.editStudent = editStudent;
      window.removeStudentConfirm = removeStudentConfirm;

      // logout (demo)
      logoutBtn.addEventListener("click", function () {
        sessionStorage.removeItem(ADMIN_FLAG);
        alert("Logged out (demo). Redirecting to login.");
        window.location.href = "index.html";
      });

      // --- Attendance Management ---
      const attendanceDate = document.getElementById("attendanceDate");
      const markAttendanceBtn = document.getElementById("markAttendanceBtn");
      const attendanceList = document.getElementById("attendanceList");

      // Set default date to today
      const today = new Date().toISOString().split("T")[0];
      attendanceDate.value = today;

      function renderAttendanceList() {
        const students = readStudents();
        attendanceList.innerHTML = "";

        if (students.length === 0) {
          attendanceList.innerHTML = "<p class='muted'>No students found.</p>";
          return;
        }

        students.forEach((student) => {
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.gap = "12px";
          div.style.padding = "8px";
          div.style.borderBottom = "1px solid rgba(0,0,0,0.06)";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `att-${student.roll}`;
          checkbox.dataset.roll = student.roll;

          const label = document.createElement("label");
          label.htmlFor = `att-${student.roll}`;
          label.textContent = `${student.name} (${student.roll})`;
          label.style.flex = "1";

          div.appendChild(checkbox);
          div.appendChild(label);
          attendanceList.appendChild(div);
        });
      }

      markAttendanceBtn.addEventListener("click", function () {
        const date = attendanceDate.value;
        const subject = document.getElementById("attendanceSubject").value;
        if (!date) {
          alert("Please select a date.");
          return;
        }
        if (!subject) {
          alert("Please select a subject.");
          return;
        }

        const students = readStudents();
        const checkboxes = attendanceList.querySelectorAll(
          'input[type="checkbox"]'
        );

        checkboxes.forEach((checkbox) => {
          const roll = checkbox.dataset.roll;
          const student = students.find((s) => s.roll === roll);
          if (student) {
            const status = checkbox.checked ? "present" : "absent";
            const entry = `${date}:${subject}:${status}`;

            // Check if date and subject already exists in attendance
            const existingEntries = student.attendance
              ? student.attendance.split(",")
              : [];
            const existingIndex = existingEntries.findIndex((e) =>
              e.startsWith(`${date}:${subject}:`)
            );

            if (existingIndex !== -1) {
              // Update existing entry
              existingEntries[existingIndex] = entry;
            } else {
              // Add new entry
              existingEntries.push(entry);
            }

            student.attendance = existingEntries.join(",");
          }
        });

        writeStudents(students);
        renderTable(searchInput.value || "");
        alert("Attendance marked successfully!");
      });

      // --- Quiz Marks Management ---
      const loadQuizMarksBtn = document.getElementById("loadQuizMarksBtn");
      const saveQuizMarksBtn = document.getElementById("saveQuizMarksBtn");
      const quizMarksList = document.getElementById("quizMarksList");

      function renderQuizMarksTable(subject) {
        const students = readStudents();
        quizMarksList.innerHTML = "";

        if (students.length === 0) {
          quizMarksList.innerHTML = "<p class='muted'>No students found.</p>";
          return;
        }

        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";

        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); text-align: left;">Roll</th>
            <th style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); text-align: left;">Name</th>
            <th style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); text-align: left;">Quiz Marks</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        students.forEach((student) => {
          const tr = document.createElement("tr");

          // Get current marks for the subject
          let currentMarks = "";
          try {
            const marksArray = JSON.parse(student.marks || "[]");
            const subjectMark = marksArray.find((m) => m.subject === subject);
            if (subjectMark) {
              currentMarks = subjectMark.marks || "";
            }
          } catch (e) {
            console.warn("Error parsing marks for student", student.roll, e);
          }

          tr.innerHTML = `
            <td style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.06);">${escapeHtml(
              student.roll || ""
            )}</td>
            <td style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.06);">${escapeHtml(
              student.name || ""
            )}</td>
            <td style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.06);">
              <input type="number" min="0" max="100" value="${currentMarks}" data-roll="${
            student.roll
          }" style="width: 80px; padding: 4px; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px;" />
            </td>
          `;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        quizMarksList.appendChild(table);
      }

      loadQuizMarksBtn.addEventListener("click", function () {
        const subject = document.getElementById("quizSubject").value;
        if (!subject) {
          alert("Please select a subject.");
          return;
        }
        renderQuizMarksTable(subject);
      });

      saveQuizMarksBtn.addEventListener("click", function () {
        const subject = document.getElementById("quizSubject").value;
        if (!subject) {
          alert("Please select a subject.");
          return;
        }

        const students = readStudents();
        const inputs = quizMarksList.querySelectorAll('input[type="number"]');

        inputs.forEach((input) => {
          const roll = input.dataset.roll;
          const marks = parseInt(input.value) || 0;
          const student = students.find((s) => s.roll === roll);
          if (student) {
            try {
              let marksArray = JSON.parse(student.marks || "[]");
              // Remove existing entry for this subject
              marksArray = marksArray.filter((m) => m.subject !== subject);
              // Add new entry
              marksArray.push({ subject, marks });
              student.marks = JSON.stringify(marksArray);
            } catch (e) {
              console.warn("Error updating marks for student", roll, e);
            }
          }
        });

        writeStudents(students);
        alert("Quiz marks saved successfully!");
      });

      // initial render
      renderTable();
      renderAttendanceList();

      // ========== Seat-grid / Year-Section logic for admin ==========
      (function () {
        const $ = (sel) => document.querySelector(sel);

        const yearSelect = $("#yearSelect");
        const sectionSelect = $("#sectionSelect");
        const generateSeatsBtn = $("#generateSeatsBtn");
        const seatGridContainer = $("#seatGridContainer");

        function populateYearOptions() {
          const years = [];
          for (let y = 2023; y <= 2028; y++) years.push(`${y}-${y + 4}`);
          yearSelect.innerHTML = "";
          years.forEach((y) => {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
          });
        }

        function populateSectionOptions() {
          sectionSelect.innerHTML = "";
          for (let i = 1; i <= 30; i++) {
            const opt = document.createElement("option");
            opt.value = `CSE-${i}`;
            opt.textContent = `CSE ${i}`;
            sectionSelect.appendChild(opt);
          }
        }

        function renderSeatGrid(year, section) {
          const students =
            typeof readStudents === "function"
              ? readStudents()
              : JSON.parse(localStorage.getItem("codepulse_students") || "[]");

          seatGridContainer.innerHTML = "";
          const grid = document.createElement("div");
          grid.className = "seat-grid";

          // Only show occupied seats (1-30 that have students)
          for (let seat = 1; seat <= 30; seat++) {
            const roll = `${year}_${section}_${String(seat).padStart(2, "0")}`;
            const student = students.find((s) => s.roll === roll);
            if (!student) continue; // Skip empty seats

            const tile = document.createElement("div");
            tile.className = "seat-tile occupied";
            tile.dataset.roll = roll;

            const rEl = document.createElement("div");
            rEl.className = "seat-roll";
            rEl.textContent = seat;

            const nEl = document.createElement("div");
            nEl.className = "seat-name";
            nEl.textContent = `${student.name || "Student"} (${
              student.section || ""
            })`;

            tile.appendChild(rEl);
            tile.appendChild(nEl);

            // Click -> open modal to add/edit
            tile.addEventListener("click", () => {
              if (sessionStorage.getItem("codepulse_role") !== "admin") {
                alert("Only admins can add/edit students.");
                return;
              }

              const existing = students.find((s) => s.roll === roll);
              if (existing) {
                // Edit mode
                modalTitle.textContent = `Edit — ${existing.name} (${existing.roll})`;
                editingRoll = existing.roll;
                deleteBtn.style.display = "inline-block";
              } else {
                // Add mode
                modalTitle.textContent = "Add New Student";
                editingRoll = null;
                deleteBtn.style.display = "none";
                studentForm.reset();
              }

              // Fill form
              fRoll.value = roll;
              fName.value = existing ? existing.name || "" : "";
              fCollege.value = existing ? existing.college || "" : "";
              fBranch.value = existing ? existing.branch || "" : "";
              fSemester.value = existing ? existing.semester || "" : "";
              fStreak.value = existing ? existing.streak || 0 : "";
              fEmail.value = existing ? existing.email || "" : "";
              fLocation.value = existing ? existing.location || "" : "";
              fGithub.value = existing ? existing.github || "" : "";
              fLinkedin.value = existing ? existing.linkedin || "" : "";
              fCodeforces.value = existing ? existing.codeforces || "" : "";
              fCodechef.value = existing ? existing.codechef || "" : "";
              fAttendance.value = existing ? existing.attendance || "" : "";
              fMarks.value = existing ? existing.marks || "[]" : "[]";
              document.getElementById("fPassword").value = existing
                ? existing.password || ""
                : "";

              setFormReadonly(false);
              modal.style.display = "flex";
            });

            grid.appendChild(tile);
          }

          // If no occupied seats, show message
          if (grid.children.length === 0) {
            const emptyMsg = document.createElement("p");
            emptyMsg.className = "muted";
            emptyMsg.textContent = "No students found in this section.";
            seatGridContainer.appendChild(emptyMsg);
          } else {
            seatGridContainer.appendChild(grid);
          }
        }

        generateSeatsBtn.addEventListener("click", () => {
          renderSeatGrid(yearSelect.value, sectionSelect.value);
        });

        populateYearOptions();
        populateSectionOptions();

        document.addEventListener("DOMContentLoaded", () => {
          renderSeatGrid(yearSelect.value, sectionSelect.value);
        });
      })();

      /* End of admin dashboard JS */
    </script>
  </body>
</html>
